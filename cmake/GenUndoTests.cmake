include(${ROOT}/cmake/GenHelpers.cmake)
message(STATUS "Generating undo tests")
set(S_TESTS
    "âˆ§Â´{ğ•©â‰¡ğ•©â¼ğ•©}Â¨âŸ¨Â¯âˆ,3,@,'â¼',â†•4âŸ©"
    "3â¼4"
    "2â€¿3â¼2â€¿3.1"
    "âˆ§Â´ {(ğ•â‰¡ğ•â¼)ğ•©}âŸœÂ¯0.3â€¿0â€¿8Â¨ +â€¿-â€¿Ã·â€¿Â¬â€¿âŠ¢â€¿âŠ£â€¿âŒ½"
    "-â¼ 'a'"
    "Ã—â¼ 5"
    "(âˆšâˆšâ¼)âŠ¸â‰¡ 0â€¿0.4â€¿Ï€â€¿1e9â€¿âˆ"
    "(â‹†â¼â‹†)âŠ¸â‰¡ â†•4"
    "1eÂ¯14>|1-â‹†+Â´â‹†â¼1(âŠ¢Ã·Â«)1+â†•11"
    "âˆ§Â´ {ğ•©â‰¡6ğ•6ğ•â¼ğ•©}âŸœ1â€¿2â€¿3Â¨ +â€¿-â€¿Ã—â€¿Ã·â€¿âˆšâ€¿âˆ§â€¿Â¬â€¿âŠ¢"
    "'a' â‰¡ 3+â¼'d'"
    "'d'-â¼'a'"
    "0.3â€¿1.01â€¿Ï€(â‹†â¼âŒœâ‰¡Ã·ËœâŒœâ—‹(â‹†â¼))0â€¿2â€¿5.6â€¿âˆ"
    "(âŠ¢â‰¡âŠ£â¼Ëœ)\\\"abcd\\\""
    "\\\"ab\\\"âŠ£â¼\\\"ac\\\""
    "(<â¼<)Â¨âŠ¸â‰¡âŸ¨0,âŸ¨âŸ©,\\\"abc\\\"âŸ©"
    "(/â¼/)âŠ¸â‰¡1â€¿0â€¿2â€¿4"
    "âŸ¨âŸ©â‰¡/â¼âŸ¨âŸ©"
    "(3âŠ¸âŒ½â‰¡2âŒ½â¼âŠ¢)â†•5"
    "((â‰¢â‰â¼)â‰¡Â¯1âŒ½â‰¢)â†•â†•4"
    "â‰¡Â´â‰âŸÂ¯1â€¿2â¥ŠâŸœ(â†•Ã—Â´)2â€¿3â€¿3"
    "2â€¿1(âŠ¢â‰¡âŠ£â‰â‰â¼)â¥ŠâŸœ(â†•Ã—Â´)2â€¿3â€¿1â€¿4"
    "âˆ§Â´ {6(ğ•Ëœâ¼â‰¡ğ•â¼)ğ•©}âŸœÂ¯0.8â€¿0â€¿3Â¨ +â€¿Ã—â€¿âˆ§"
    "+Ëœâ¼7"
    "âˆ¨Ëœâ¼0.75"
    "+Â´âˆŠâŸ¨âˆš,Ã—Ëœâ¼,âˆ§Ëœâ¼âŸ©{ğ•ğ•©}âŒœ0â€¿2â€¿âˆ"
    "âˆ§Â´ -â€¿Ã·â€¿â‹† {3(ğ•Ëœâ¼â‰¡ğ•)2â€¿Ï€âˆ¾â‹†2}Â¨ +â€¿Ã—â€¿âˆš"
    "16âˆšËœâ¼2"
    "4â€¿2â€¿0(Â¬Ëœâ¼â‰¡Â¯1++)1â€¿2â€¿9"
    "-Â¨â¼ 2"
    "-âŒœâ¼ 2"
    "-Ë˜â¼ 2"
    "-Ë˜â¼ <2"
    "-\\`â¼ 2"
    "0-Â´â¼ 2"
    "(âˆ¾Ëœ â‰¡ Â·(<âŒœâ¼âˆ¾<Â¨â¼)<Â¨) \\\"abcd\\\""
    "\\\"ab\\\"â€¿\\\"abc\\\"â‰¡1âŒ½â¼Â¨\\\"ba\\\"â€¿\\\"bca\\\""
    "(2-=âŒœËœâ†•2)â‰¡/Ë˜â¼0â€¿1â€¿1â‰0â€¿0â€¿1"
    "2(âŒ½Ë˜â¼â‰¡Â·â‰âŒ½â¼âŸœâ‰)â‰\\\"abcde\\\""
    "(4â¥Š1) â‰¡ +\\`â¼ 1+â†•4"
    "âŸ¨âŸ© â‰¡ !\\`â¼âŸ¨âŸ©"
    "(-âŸœÂ» â‰¡ +\\`â¼) 2|âŒŠÃ—âŒœËœÏ€+â†•5"
    "(5â¥Š2)â‰¡2Ã·\\`â¼2â‹†-â†•5"
    "(0â€¿1â€¿1Ã—âŒœâ¥ŠËœ4)â‰¡(â†•4)+\\`â¼3â€¿4â¥Šâ†•12"
    "(â†•3)+\\`â¼3â€¿4â¥Šâ†•12"
    "(Ã·Â¬)â¼ 4"
    "âŠ¢âˆ˜âˆšâ¼ 2"
    "(âŒ½/1â€¿3)â‰¡(Â·+\\`âŒ½)â¼â†•4"
    "(âŒ½âŠ¸/1â€¿3)â‰¡(âŒ½Â·-\\`âŒ½)â¼â†•4"
    "(Â¯1â€¿0+âŒœ\\\"BQN\\\")â‰¡(1âŒ½â‰)â¼3â€¿2â¥Š\\\"PQMNAB\\\""
    "(3Ã—Â·âˆš2+Â¬)â¼6"
    "(3âŠ¸âˆš+âŸœ7)â¼2"
    "5Ã—âŸœÂ¬â¼10"
    "(âˆš-2{ğ”½})â¼1"
    "(âˆš-2Ë™)â¼1"
    "21(1+Ã·)â¼8"
    "(2âŠ¸âŒ½ â‰¡ 2âŠ¸(-âŠ¸âŒ½)â¼)\\\"abcde\\\""
    "Â¯2 Ã·Ëœâ—‹Â¬â¼ Â¯1"
    "1eÂ¯12>|16- 2 Ã·Ëœâ—‹(â‹†â¼)â¼ 4"
    "(+\\`âŒ¾âŒ½â¼â‰¡+\\`â¼âŒ¾âŒ½) â†•4"
    "Ã—ËœâŸ3â¼256"
    "âˆšâŠ˜-{ğ•—â¼â‰¡6ğ•—â¼âŠ¢} Â¯3â€¿2"
    "âˆ§Â´ {(ğ•â‰¡ğ•â¼â¼)ğ•©}âŸœ2â€¿4â€¿1Â¨ /â€¿âŒ½â€¿<"
    "/â¼â¼2â€¿3â€¿0"
    "/âŸÂ¯1â¼2â€¿3â€¿0"
)

set(S_ANS
    "1"
    "!"
    "!"
    "1"
    "!"
    "!"
    "1"
    "1"
    "1"
    "1"
    "1"
    "3"
    "1"
    "1"
    "!"
    "1"
    "1"
    "1"
    "1"
    "1"
    "1"
    "1"
    "1"
    "3.5"
    "0.5"
    "1"
    "1"
    "4"
    "1"
    "!"
    "!"
    "!"
    "!"
    "!"
    "!"
    "1"
    "1"
    "1"
    "1"
    "1"
    "1"
    "1"
    "1"
    "1"
    "!"
    "0.75"
    "4"
    "1"
    "1"
    "1"
    "-1"
    "1"
    "-1"
    "9"
    "9"
    "3"
    "1"
    "4"
    "1"
    "1"
    "2"
    "1"
    "1"
    "!"
    "!"
)

set(S_TEST_SOURCE ${BUILDDIR}/test_undo.cpp)
init_gen_file(${S_TEST_SOURCE})

foreach(test ans IN ZIP_LISTS S_TESTS S_ANS)
  execute_process(
    COMMAND ${BASH} -c
            "${BQN} ${ROOT}/test/ccxx.bqn ${ROOT}/ext//bqn \"${test}\""
    WORKING_DIRECTORY "${ROOT}/ext//cbqn"
    OUTPUT_VARIABLE compiled_test
  )
  string(REPLACE "Â¯" "-" cesc "${compiled_test}")
  string(REPLACE "\\`" "`" tesc "${test}")
  file(
    APPEND ${S_TEST_SOURCE}
    "
TEST_CASE(\"${tesc}\") {
  spdlog::critical(\"test='{}', ans='{}'\", \"${tesc}\", \"${ans}\");
  const auto rt = provides::get_runtime_setprims_cached();
  const auto runtime = rt->values;
  CompileParams p{
    ${cesc}
  };
  "
  )
  if("${ans}" STREQUAL "!")
    file(
      APPEND ${S_TEST_SOURCE}
      "
    REQUIRE_THROWS(vm::run(p.bc, p.consts.v, p.blk_defs, p.bodies));
}
"
    )
  else()
    file(
      APPEND ${S_TEST_SOURCE}
      "
  auto ret = vm::run(p.bc, p.consts.v, p.blk_defs, p.bodies);
  REQUIRE(nullptr != ret.v);
  REQUIRE(nullptr != ret.scp);
  auto n = dynamic_pointer_cast<Number>(ret.v);
  REQUIRE(nullptr != n);
  CHECK(${ans} == doctest::Approx(n->v));
}
"
    )
  endif()
endforeach()
