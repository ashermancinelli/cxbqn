include(${ROOT}/cmake/GenHelpers.cmake)
message(STATUS "Generating primitive throwing tests")
set(P_TESTS
    "'a'+'c'"
    "Fâ†-â‹„f+2"
    "97-'a'"
    "@-1"
    "-'a'"
    "Fâ†Ã·â‹„-f"
    "2Ã—'a'"
    "Ã·'b'"
    "Fâ†âˆš-â‹„Ã·f"
    "â‹†'Ï€'"
    "'e'â‹†'Ï€'"
    "Fâ†âŒˆâ‹„âŒŠf"
    "Fâ†+â‹„Gâ†-â‹„fâ‰¤g"
    "!0"
    "\\\"error\\\"!\\\"abc\\\""
    "âˆš'x'"
    "'a'âˆ§Â¯1"
    "Fâ†-â‹„2âˆ¨f"
    "Â¬'a'"
    "2Â¬'c'"
    "Fâ†{ğ•©}â‹„0Â¬f"
    "Fâ†+-â‹„|f"
    "26|'A'"
    "âŠ‘\\\"\\\""
    "âŠ‘2â€¿0â¥ŠâŸ¨âŸ©"
    "+Â´11"
    "-Â´<'a'"
    "Ã—Â´3â€¿1â¥Š\\\"abc\\\""
    "2â€¿3âŠ¢Â¨4â€¿5â€¿6"
    "\\\"abcd\\\"-\\\"a\\\""
    "(â†•4)Ã—(â†•3)âŠ¢âŒœâ†•2"
    "10âŠ‘â†•10"
    "Â¯11âŠ‘â†•10"
    "0.5âŠ‘â†•10"
    "'x'âŠ‘â†•10"
    "âŸ¨âŸ©âŠ‘â†•10"
    "2âŠ‘3+âŒœâ—‹â†•4"
    "21â€¿12â€¿03â‰¡âŸ¨2â€¿Â¯3â€¿0,1â€¿2,0â€¿Â¯1âŸ©âŠ‘(10Ã—â†•3)+âŒœâ†•4"
    "âŸ¨2,âŸ¨3âŸ©âŸ©âŠ‘â†•4"
    "(<2)âŠ‘â†•4"
    "(â‰â‰2)âŠ‘â†•4"
    "â†•@"
    "â†•2.4"
    "â†•<6"
    "â†•â‰2â€¿3"
    "â†•Â¯1â€¿2"
    "-Ë™â—¶Ã·â€¿Ã— 4"
    "Â¯3â¥Š3"
    "1.6â€¿2.5â¥Šâ†•4"
    "(â‰2â€¿3)â¥Šâ†•3"
    "\\\"     \\\"â‰¡5â¥Š\\\"\\\""
    "4â€¿âˆ˜â¥Šâ†•15"
    ">â†•Â¨2â€¿3"
    ">âŸ¨â¥Š2,3âŸ©"
    ">(â‰â‹ˆâŠ¢)â†•4"
    "1â€¿0â‰1â€¿2â€¿3"
    "â‰âŸœâ‰â†•3"
    "âŒ½â‰1.1 â†•4"
    "âŒ½â‰'x' â†•4"
    "âŒ½â‰(<<0) â†•4"
    "âŒ½â‰â‰ â†•4"
    "âŒ½âš‡2â€¿2.5 â†•3"
    "2+âŸ1â€¿'c'4"
    "â‹†âŸ1.5 2"
    "+\\`4"
    "+\\`<'c'"
    "3â€¿4+\\`4+âŒœâ—‹â†•3"
    "âŠ\\\"\\\""
    "âŠ0â€¿3â¥Š\\\"\\\""
    "3âŠ\\\"abc\\\""
    "1.5âŠ\\\"abc\\\""
    "'x'âŠ\\\"abc\\\""
    "âŸ¨â¥Š0,1âŸ©âŠâ‰\\\"abc\\\""
    "0â€¿0<Â¨âŠ¸âŠ\\\"abc\\\""
    "âŸ¨3â€¿Â¯âˆ,âŸ¨âŸ©âŸ©âŠ4â€¿3â¥Š0"
    "(â‰â‰<5â€¿1)âŠâ†•6â€¿2"
    "2.5â†‘\\\"abce\\\""
    "2â€¿'c'â†‘\\\"abcd\\\""
    "(â‰2â€¿3)â†‘\\\"abcd\\\""
    "0.1â†“\\\"abcd\\\""
    "âŸ¨âˆ˜âŸ©â†“\\\"abcd\\\""
    "@â†•â†•5"
    "2â€¿1â†•â†•5"
    "Â¯1â†•â†•5"
    "7â†•â†•5"
    "'a'Â«'b'"
    "\\\"a\\\"Â»'b'"
    "â‰âŠ¸Â»\\\"abc\\\""
    "âŒ½'a'"
    "âŒ½<âˆ"
    "2âŒ½'a'"
    "1â€¿2âŒ½â†•4"
    "âŒ½â€¿2âŒ½3+âŒœâ—‹â†•4"
    "(<<3)âŒ½â†•4"
    "/2"
    "/1â€¿Â¯1â€¿0"
    "/=âŒœËœâ†•2"
    "2/<2"
    "0â€¿1/\\\"abc\\\""
    "âŸ¨â†•3,â†•3âŸ©/\\\"abc\\\""
    "1â€¿2/â—‹â‰\\\"ab\\\""
    "Â¯1â€¿2/\\\"ab\\\""
    "âˆ¾'c'"
    "âˆ¾\\\"abc\\\""
    "âˆ¾â‰\\\"ab\\\"â€¿\\\"cde\\\"â€¿\\\"\\\""
    "âˆ¾âŸ¨2â€¿3,1â€¿3,2â€¿2âŸ©â¥ŠÂ¨0"
    "'a'âˆ¾â‰\\\"abc\\\""
    "\\\"ab\\\"âˆ¾â—‹â‰\\\"cde\\\""
    "(2â€¿3â¥Šâ†•6)âˆ¾â†•2"
    "âŠ”3"
    "âŠ”<3"
    "âŠ”â‰â†•3"
    "âŠ”1.5â€¿0â€¿2"
    "âŠ”1â€¿Â¯2"
    "âŠ”Ëœ'a'â€¿1â€¿0"
    "4âŠ”â—‹â†•2"
    "âŸ¨1â€¿2,3â€¿1âŸ©âŠ”2â€¿3â¥Š0"
    "âŸ¨1â€¿2,3â€¿4â€¿5,6â€¿7âŸ©âŠ”2â€¿3â¥Š0"
    "â‰âŠ¸âŠ”â‰Ë˜â†•3"
    "âŸ¨âŸ¨<3,2âŸ©,Â¯1â€¿0â€¿Â¯1âŸ©âŠ”2â€¿3â€¿4â¥Šâ†•24"
    "(2â€¿3â¥Šâ†•4)âŠ”â†•2â€¿2"
    "(3â€¿3â¥Šâ†•4)âŠ”â†•2â€¿2"
    "âŠËœ'a'"
    "âŠâŠ¸âŠ\\\"abc\\\""
    "(3â€¿2â€¿4â¥Š0)âŠ4â¥Š1"
    "âŠ+Ë™@"
    "(â†•5)âˆŠ1"
    "2âˆŠâ‰Ë˜â†•4"
    "âˆŠ<4"
    "â·'a'"
    "â‰âŠ¸â·\\\"abc\\\""
    "0â€¿Â¯1â€¿1â‰(3â¥Š1)â¥Š1"
    "1â€¿0â‰Ë˜âŠ¸â‰\\\"ab\\\"â‰\\\"cd\\\""
    "0â€¿2â‰+âŒœËœâ†•3"
    "2â€¿0â€¿0â‰â†•â†•3"
    "3â‰â†•â†•3"
    "â‹'a'"
    "â‹'a'â€¿âˆ˜"
    "â’2"
    "âˆ§âŠâŸ¨+âŸ©"
    "âˆ§+â€¿-"
    "âˆ¨'c'"
    "â‹Ëœ6"
    "â’âŸœâ†•4"
    "(3â€¿2â€¿4â¥Š0)â‹4â¥Š1"
    "(3â€¿2â€¿4â¥Š0)â’1"
    "âŸ¨+âŸ©â‹â†•6"
    "âŸ¨1â€¿3â€¿1,1â€¿3â€¿2âŸ©â’âŸ¨1â€¿3â€¿{ğ•©}âŸ©"
    "â‰âŒ¾â‰ \\\"abc\\\""
    "-âŒ¾âŠ 4"
    "â†•âˆ˜â‰ âŠ¸+âŒ¾(10âŠ¸â¥Š)â†•6"
    "â†•âˆ˜â‰ âŠ¸+âŒ¾(2âŠ¸/)â†•5"
    "1âŠ¸âŒ½âŒ¾(1â€¿3â€¿3â€¿0âŠ¸âŠ)\\\"abcd\\\""
    "âŒ½âŒ¾(1â†“4â†‘âŠ¢)\\\"abc\\\""
)

set(P_TEST_SOURCE "${BUILDDIR}/test_prim_throws.cpp")
set(P_SETPRIMS_TEST_SOURCE "${BUILDDIR}/test_prim_setprims_throws.cpp")
init_gen_file(${P_TEST_SOURCE})
init_gen_file(${P_SETPRIMS_TEST_SOURCE})

foreach(test ${P_TESTS})
  execute_process(
    COMMAND ${BASH} -c
            "${BQN} ${ROOT}/test/ccxx.bqn ${ROOT}/ext//bqn -i \"${test}\""
    WORKING_DIRECTORY "${ROOT}/ext//cbqn"
    OUTPUT_VARIABLE compiled_test
  )
  string(REPLACE "\\`" "`" esc "${test}")
  file(
    APPEND ${P_SETPRIMS_TEST_SOURCE}
    "
      TEST_CASE(\"${esc}\") {
      const auto rt = provides::get_runtime_setprims_cached_annot();
      const auto runtime = rt->values;
      spdlog::critical(\"test='{}'\", \"${esc}\");
      CompileParams p( ${compiled_test} );
      REQUIRE_THROWS(vm::run(p.bc, p.consts.v, p.blk_defs, p.bodies, p.source_indices.value(), p.source_str));
      }
      "
  )
  file(
    APPEND ${P_TEST_SOURCE}
    "
      TEST_CASE(\"${esc}\") {
      const auto rt = provides::get_runtime_cached();
      const auto runtime = rt->values;
      spdlog::critical(\"test='{}'\", \"${esc}\");
      CompileParams p{ ${compiled_test} };
      REQUIRE_THROWS(vm::run(p.bc, p.consts.v, p.blk_defs, p.bodies));
      }
      "
  )
endforeach()
