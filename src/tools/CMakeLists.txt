message(STATUS "Configuring cxbqn tools")
configure_file(cxbqn-config.in ${PROJECT_BINARY_DIR}/cxbqn-config)
configure_file(vars.bqn.in ${PROJECT_BINARY_DIR}/vars.bqn)

install(
  FILES ${PROJECT_BINARY_DIR}/cxbqn-config
  DESTINATION bin
  PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE
)
install(FILES ${PROJECT_BINARY_DIR}/vars.bqn DESTINATION share/bqn/cxbqn)

add_executable(bqn-format bqn_format.cpp)
target_link_libraries(bqn-format PRIVATE cxbqn::tpl)
target_include_directories(
  bqn-format PRIVATE ${PROJECT_SOURCE_DIR}/ext/spirit-1.78.0/include
)
install(TARGETS bqn-format DESTINATION bin)

file(REMOVE ${PROJECT_BINARY_DIR}/bcgen.sh)
file(
  WRITE ${PROJECT_BINARY_DIR}/ccx-wrapper.sh
  "
# Do not edit! This file was generated by the CXBQN build system on ${TODAY}
cd ${PROJECT_SOURCE_DIR}/ext/cbqn
${CMAKE_CURRENT_SOURCE_DIR}/ccx.bqn ${PROJECT_SOURCE_DIR}/ext//bqn \"$@\"
"
)
file(
  WRITE ${PROJECT_BINARY_DIR}/regen-precomp.sh
  "
# Do not edit! This file was generated by the CXBQN build system on ${TODAY}
cd ${PROJECT_BINARY_DIR}
for i in c f r r0 r1; do
  echo $i
  ./ccx-wrapper.sh $i > \"${PROJECT_SOURCE_DIR}/include/cxbqn/__/$i\"
done
"
)
execute_process(
  COMMAND ${BASH} -c "chmod +x ccx-wrapper.sh"
  COMMAND ${BASH} -c "chmod +x regen-precomp.sh"
  WORKING_DIRECTORY ${PROJECT_BINARY_DIR}
)
