#!/usr/bin/env bqn
# Modified version of https://github.com/mlochbaum/BQN/blob/master/src/cjs.bqn, which is under the ISC license (https://github.com/mlochbaum/BQN/blob/master/LICENSE)

argsâ†â€¢args
"Usage: ./ccx.bqn path/to/mlochbaum/BQN [-i] <(r|r0|r1|c|cc|f|e|p) or an expression>"!2â‰¤â‰ args
return â† 1â‰¡âŠ‘args
argsâ†“Ëœâ†© return
pathâ†(âŠ‘args)âˆ¾"/src/"
argsâ†“Ëœâ†©1
Import â† {ğ•¨â€¢Import pathâˆ¾ğ•©}
FChars â† {ğ•¨â€¢FChars pathâˆ¾ğ•©}
FLines â† {ğ•¨â€¢FLines pathâˆ¾ğ•©}

split â† â€¢Import "../lib/strings/split.bqn"
replaceall â† â€¢Import "../lib/strings/replaceall.bqn"

F â† â€¢Repr  # Format number
# Escape the special characters that appear in BQN sources.
Escâ†{
  in â† (@+0â€¿9â€¿10â€¿13)âˆ¾"'"""   # Null, Tab, LF, CR, and quotes
  out â† "0tnr"               # Whitespace characters changed to letters
  i â† inâŠğ•©
  ğ•© â†© i âŠâŸœoutâŒ¾((i<â‰ out)âŠ¸/) ğ•© # Replace
  âˆ¾(i<â‰ in) /âŸœ"\"âŠ¸âˆ¾Â¨ ğ•©        # Insert \
}

OStr â† "CXBQN_NEW(Array,U"""âˆ¾Escâˆ¾""")"Ë™  # A BQN string
OChr â† {"CXBQN_NEW(Character,U'"âˆ¾(Escâ¥Šğ•©)âˆ¾"')"} # A BQN character
ONum â† {sâ†"-"/Ëœğ•©<0 â‹„ âˆâŠ¸=âˆ˜|â—¶âŸ¨"CXBQN_NEW(Number,"âˆ¾")"âˆ¾Ëœsâˆ¾Fâˆ˜| â‹„ "CXBQN_NEW(Number,"âˆ¾sâˆ¾"1.0/0.0)"âŸ©ğ•©} # Format number
OAny â† â‰¡â—¶âŸ¨@âŠ¸â‰¤â—¶ONumâ€¿OChr, OStr, âŠ‘âŸ©

List â† (0<â‰ )â—¶âŸ¨"",1â†“Â·âˆ¾","âŠ¸âˆ¾Â¨âŸ©
ShortList â† {"{"âˆ¾(Listğ•©)âˆ¾"}"}
LongList â† {"{"âˆ¾(Listğ•©)âˆ¾"}"}
MakeList â† (â‰ âˆ˜âŠ¢>4Ë™)â—¶ShortListâ€¿LongList
Li â†  {"i32" MakeList FÂ¨ğ•©}
_Lo â† {"B"   MakeList ğ”½Â¨ğ•©}


glyphs â† Import "glyphs.bqn"
_getComp â† { (4+2Ã—useInd)â†‘ <âˆ˜âŠ¢âˆ¾Ëœ 5â†‘ (ğ•— Import "c.bqn"){ğ”½} }
useInd â† "-i"â‰¡âŠ‘args â‹„ argsâ†“Ëœâ†©useInd
Comp â† ((<"runtime["âˆ¾Fâˆ¾"]"Ë™)Â¨â†•â‰ âˆ¾glyphs) glyphs _getComp âŠ¢
J â† âˆ¾âˆ¾âŸœ(@+10)Â¨

Fout â† {
  ((â‰ ğ•©)â†‘âŸ¨Li â‹„ OAny _Lo â‹„ =â—¶âŸ¨ONum,Li _LoâŸ© _Lo _Lo â‹„ (Li 2âŠ¸â†‘) _Lo â‹„ Li _Lo â‹„ OStrâŸ©) {ğ•ğ•©}Â¨ ğ•©
}

Frun â† 1âŠ¸Fout
Long â† {Â¯2â†“âˆ¾ğ•©âˆ¾Â¨<","âˆ¾@+10}
LFC â† Longâˆ˜Foutâˆ˜{oâ†Compğ•©}

RT â† {
  srcâ€¿needâ€¿inputsâ†ğ•©Import"pr.bqn"
  prâ†"runtime_0"â€¿"provide"{(âˆ¾ğ•¨<âŠ¸(<âˆ˜{âˆ¾""â€¿ğ•¨â€¿"["â€¿ğ•©â€¿"]"}âŸœFÂ¨)âŸœ(â†•â‰ )Â¨ğ•©)âŠËœ(âˆ¾ğ•©)âŠâˆ¾need}â—‹((-1+1=ğ•©)âŠ¸â†‘)inputs
  Long Fout pr need _getComp src
}
CArg â† {J (Â¯5âŠ¸â†“âˆ¾ğ•©Ë™)âŒ¾âŠ‘ FLines "c.bqn"}
SVG â† {âˆ¾âŸ¨"Modifyâ†GetHighlightsâ†âŠ¢â‹„"âŸ©âˆ¾ FCharsâˆ˜âˆ¾âŸœ".bqn"Â¨ "../svg"â€¿ğ•©}

râ†(âŠ‘"r"â€¿"r0"â€¿"r1"â€¿"c"â€¿"cc"â€¿"f"â€¿"e"â€¿"p"âŠâŠ)â—¶âŸ¨
  RTâˆ˜2, RTâˆ˜0, RTâˆ˜1
  {ğ•©â‹„LFC CArg "âŸ¨"âˆ¾"âŸ©"Â«âˆ¾","âŠ¸âˆ¾Â¨'"'(âŠ£âˆ¾âˆ¾Ëœ)Â¨glyphs}
  {ğ•©â‹„LFC "{"âˆ¾"}"âˆ¾ËœCArg"ğ•©"}
  {ğ•©â‹„LFC FChars "f.bqn"}
  {ğ•©â‹„LFC SVG "e"}
  {ğ•©â‹„LFC SVG "p"}
  âˆ¾LFCÂ¨
âŸ© args

# Split into lines
bcâ€¿constsâ€¿blkâ€¿bod â† (@+10) Split r

# Just replace the CXBQN_NEWs in the blocks as we don't need them there
blk2â†âŸ¨")"âŸ©â€¿âŸ¨""âŸ© ReplaceAll âŸ¨"CXBQN_NEW(Number,"âŸ©â€¿âŸ¨""âŸ© ReplaceAll blk

# No comma
NC â† {1âŠ¸â†“âŒ¾âŒ½""âˆ¾ğ•©}

â€¢Show Â¨constsâ€¿blk2â€¿bcâ€¿bod

â€¢Out "[=] {
  std::vector<O<Value>> c"âˆ¾(NC consts)âˆ¾";
  std::vector<BlockDef> bds"âˆ¾(NC blk2)âˆ¾";
  auto cu = make_observer(new CompUnit{
      ._bc"âˆ¾(NC bc)âˆ¾",
      ._consts{CXBQN_NEW(Array,c.size())},
      ._blocks{},
      ._bodies"âˆ¾(NC bod)âˆ¾"},
      });
  for (auto& bd : bds)
    cu->_blocks.emplace_back(bd);
  cu->_consts->values = std::move(c);
  cu->_consts->shape.push_back(c.size());
  GC::register_ptr(cu.get());
  return cu;
}()"
